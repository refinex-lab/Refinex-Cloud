# è¿œç¨‹æœåŠ¡è°ƒç”¨

è¯¥éƒ¨åˆ†æ ¹æ® [Spring Cloud OpenFeign å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html)ï¼Œè¿›è¡Œå¾®æœåŠ¡é¡¹ç›®ä¸­ä½¿ç”¨ OpenFeign çš„åŸºæœ¬çº¦å®šã€‚

## ä¸€ã€ç†è§£å®˜æ–¹æ–‡æ¡£çš„æ ¸å¿ƒæ€æƒ³

---

<center>Spring Cloud OpenFeign Features - Feign Inheritance Support</center>

Feign supports boilerplate apis via single-inheritance interfaces. This allows grouping common operations into convenient base interfaces.

UserService.java

```java
public interface UserService {

	@GetMapping("/users/{id}")
	User getUser(@PathVariable("id") long id);
}
```

UserResource.java

```java
@RestController
public class UserResource implements UserService {

}
```

UserClient.java

```java
@FeignClient("users")
public interface UserClient extends UserService {

}
```

> WARNING: `@FeignClient` interfaces should not be shared between server and client and annotating `@FeignClient` interfaces with `@RequestMapping` on class level is no longer supported.

---

ä¸Šè¿°å®˜æ–¹æ–‡æ¡£çš„è¿™æ®µä»‹ç»å¯ä»¥æ‹†è§£æˆä¸‰å±‚æ„æ€ç†è§£ ğŸ‘‡

### 1. Feign æ”¯æŒæ¥å£ç»§æ‰¿ï¼ˆboilerplate apisï¼‰

ä½ å¯ä»¥å°†ä¸€ç»„é€šç”¨çš„æ¥å£ï¼ˆHTTP è°ƒç”¨å®šä¹‰ï¼‰æŠ½å–åˆ°ä¸€ä¸ª â€œåŸºç±»æ¥å£â€ ä¸­ï¼Œ å…¶ä»–æœåŠ¡åªéœ€ extends è¯¥æ¥å£ï¼Œå°±èƒ½å¤ç”¨æ–¹æ³•å®šä¹‰ï¼Œå‡å°‘é‡å¤ã€‚

ç¤ºä¾‹å¦‚ä¸‹:

```java
// æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ @RestController æˆ– @FeignClient æ³¨è§£ï¼Œåªæ˜¯å®šä¹‰ HTTP è°ƒç”¨æ¥å£å¥‘çº¦
public interface UserService { // 1. å®šä¹‰æœåŠ¡æä¾›æ–¹çš„ HTTP è°ƒç”¨æ¥å£
    
    // 2. å®šä¹‰ HTTP è°ƒç”¨æ¥å£çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬è·¯å¾„ã€å‚æ•°ã€è¿”å›å€¼ç­‰
    @GetMapping("/users/{id}")
    User getUser(@PathVariable("id") long id);
}
```

è¿™ä¸ªæ¥å£åªå®šä¹‰ **APIå¥‘çº¦ï¼ˆContractï¼‰**ï¼Œä¸å…³å¿ƒè°ƒç”¨æ–¹å¼ï¼ˆFeignï¼‰è¿˜æ˜¯å®ç°æ–¹å¼ï¼ˆControllerï¼‰ã€‚

### 2. æœåŠ¡æä¾›æ–¹ç›´æ¥å®ç°æ¥å£

æœåŠ¡æä¾›æ–¹ç›´æ¥å®ç° (implements) è¯¥æ¥å£ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ **Controller å±‚ä¸è¿œç¨‹è°ƒç”¨å®šä¹‰ä¸¥æ ¼ä¸€è‡´**ï¼š

```java
@RestController // 1. æ ‡æ³¨ä¸º RESTful æ§åˆ¶å™¨
public class UserResource implements UserService { // 2. å®ç°æœåŠ¡æä¾›æ–¹å®šä¹‰çš„æ¥å£
    
    // 3. å®ç°æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤„ç† HTTP è¯·æ±‚ï¼Œä¸éœ€è¦å†é‡å¤ç¼–å†™æ³¨è§£ã€è·¯å¾„
    @Override
    public User getUser(long id) {
        return userRepository.findById(id);
    }
}
```

è¿™æ ·æœåŠ¡æä¾›æ–¹æ— éœ€å†é‡å¤ç¼–å†™æ³¨è§£ã€è·¯å¾„ï¼Œè‡ªåŠ¨ä¿æŒä¸€è‡´æ€§ã€‚

### 3. å®¢æˆ·ç«¯é€šè¿‡ FeignClient ç»§æ‰¿æ¥å£å®ç°è¿œç¨‹è°ƒç”¨

Feign å®¢æˆ·ç«¯é€šè¿‡ç»§æ‰¿ (extends) åŒä¸€ä¸ªæ¥å£è¿›è¡Œå£°æ˜ï¼š

```java
@FeignClient("user-service") // 1. æ³¨å†Œåˆ° Nacos çš„æœåŠ¡æä¾›æ–¹å®ä¾‹å
public interface UserClient extends UserService { // 2. ç»§æ‰¿æœåŠ¡æä¾›æ–¹å®šä¹‰çš„æ¥å£
    // 3. æœåŠ¡è°ƒç”¨æ–¹åªéœ€è¦æ³¨å…¥æ­¤æ¥å£ï¼Œå³å¯é€šè¿‡ Feign è°ƒç”¨æœåŠ¡æä¾›æ–¹çš„æ–¹æ³•
}
```

> âš ï¸ **å®˜æ–¹çš„è­¦å‘Šé‡ç‚¹ï¼š**
> 
> â€œ`@FeignClient` interfaces should not be shared between server and client and annotating `@FeignClient` interfaces with `@RequestMapping` on class level is no longer supported.â€
> 
> æ„æ€æ˜¯ï¼š
> 1. **ä¸è¦å°† `@FeignClient` æ¥å£ç›´æ¥åœ¨æœåŠ¡æä¾›æ–¹ä¸è°ƒç”¨æ–¹å…±äº«**ï¼ˆä¾‹å¦‚æ”¾åˆ°åŒä¸€ä¸ªå…¬å…±æ¨¡å—ï¼‰ï¼›
> 2. **ä¸è¦åœ¨ Feign æ¥å£ä¸ŠåŠ ç±»çº§åˆ«çš„ `@RequestMapping`**ï¼ˆè·¯å¾„ç»Ÿä¸€åº”ç”±æœåŠ¡æä¾›æ–¹çš„ Controller æˆ–å¥‘çº¦æ¥å£å®šä¹‰ï¼‰ã€‚

## äºŒã€å®˜æ–¹æ¨èçš„åˆ†å±‚è®¾è®¡ç†å¿µ

> ç®€è¨€ä¹‹ï¼š**å¥‘çº¦ï¼ˆAPI å®šä¹‰ï¼‰ç‹¬ç«‹æˆæ¨¡å—ï¼Œè°ƒç”¨æ–¹ä¸æä¾›æ–¹å„è‡ªå¼•ç”¨è¯¥å¥‘çº¦**ã€‚

è¿™ç§ç»“æ„ç§°ä¸º â€œ**API å¥‘çº¦åˆ†ç¦»ï¼ˆContract-firstï¼‰**â€ è®¾è®¡æ¨¡å¼ã€‚

åŸºäºå®˜æ–¹æ¨èï¼Œæœ¬é¡¹ç›®çš„æ¨¡å—ç»“æ„æ¨èå¦‚ä¸‹:

```text
refinex-cloud/
â”‚
â”œâ”€â”€ refinex-api/                      â† å…¬å…±å¥‘çº¦æ¥å£æ¨¡å—ï¼ˆåªå®šä¹‰æ¥å£ï¼Œä¸åŠ  @FeignClientï¼‰
â”‚   â””â”€â”€ refinex-api-platform/         â† å¹³å°ç›¸å…³çš„ API å¥‘çº¦æ¨¡å—
â”‚       â”œâ”€â”€ cn.refinex.client/        â† æ¥å£å¥‘çº¦ç»Ÿä¸€çº¦å®šæ”¾åœ¨ client åŒ…ä¸‹
â”‚       â”‚   â””â”€â”€ user/                 â† æ¨¡å—çº§åˆ«çš„åŒ…ï¼Œç”¨äºç»„ç»‡ç”¨æˆ·ç›¸å…³çš„ API å¥‘çº¦
â”‚       â”‚       â”œâ”€â”€ UserService.java  â† é€šç”¨APIæ¥å£å®šä¹‰
â”‚       â”‚       â””â”€â”€ dto/              â† æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰åŒ…ï¼Œç”¨äºå®šä¹‰è¯·æ±‚å‚æ•°ã€å“åº”ç»“æœç­‰
â”‚       â”‚           â””â”€â”€ UserDTO.java
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ refinex-platform/                 â† æœåŠ¡æä¾›æ–¹
â”‚   â””â”€â”€ cn.refinex.platform/
â”‚       â”œâ”€â”€ controller/               â† æ§åˆ¶å™¨åŒ…ï¼Œç”¨äºå¤„ç† HTTP è¯·æ±‚
â”‚       â”‚   â””â”€â”€ UserController.java   â† å®ç°å¥‘çº¦å±‚çš„ UserService æ¥å£
â”‚       â”œâ”€â”€ service/
â”‚       â””â”€â”€ repository/
â”‚
â”œâ”€â”€ refinex-auth/                     â† æœåŠ¡è°ƒç”¨æ–¹ï¼ˆFeign å®¢æˆ·ç«¯ï¼‰
â”‚   â””â”€â”€ cn.refinex.auth/
â”‚       â”œâ”€â”€ feign/                    â† Feign å®¢æˆ·ç«¯åŒ…ï¼Œç”¨äºå®šä¹‰è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œç»§æ‰¿æœåŠ¡æä¾›æ–¹å®šä¹‰çš„æ¥å£
â”‚       â”‚   â””â”€â”€ UserFeignClient.java  â† extends UserService
â”‚       â”œâ”€â”€ service/
â”‚       â””â”€â”€ controller/
â”‚
â””â”€â”€ refinex-gateway/
```

## ä¸‰ã€åŒ…è·¯å¾„ä¸å‘½åè§„èŒƒå»ºè®®

### 3.1 é€šç”¨ OpenFeign æ¥å£å±‚æ¨¡å—ï¼ˆå¥‘çº¦æ¨¡å—ï¼‰

æ¨¡å—åå»ºè®®ï¼š refinex-api-<service-name>

åŒ…å‘½åå»ºè®®ï¼š

```java
cn.refinex.api.[ä¸šåŠ¡åŸŸ].client   â† å­˜æ”¾APIæ¥å£
cn.refinex.api.[ä¸šåŠ¡åŸŸ].dto      â† å­˜æ”¾DTO/VO
cn.refinex.api.[ä¸šåŠ¡åŸŸ].enums    â† å­˜æ”¾æšä¸¾
```

æ¥å£å±‚æ¨¡å—å¯ä»¥å¼•å…¥ Knife4j ç›¸å…³ä¾èµ–, ç”¨äºç”Ÿæˆ Swagger æ–‡æ¡£å’Œå‚æ•°æ ¡éªŒä¾èµ–å³å¯:

```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
    <optional>true</optional>
</dependency>
```

ç¤ºä¾‹ï¼š

```java
package cn.refinex.api.user.client;

public interface UserService {
    @GetMapping("/users/{id}")
    UserDTO getUser(@PathVariable("id") Long id);
}
```

> æ³¨æ„ï¼š
> 1. ä¸åŒ…å« `@FeignClient` æ³¨è§£
> 2. ä¸åŒ…å« `@RestController` æ³¨è§£
> 3. ä»…å®šä¹‰ API å¥‘çº¦ä¸æ•°æ®æ¨¡å‹

Swagger/Knife4j èšåˆæ—¶å¯ç›´æ¥åŸºäºå¥‘çº¦æ¥å£ç”Ÿæˆç»Ÿä¸€æ–‡æ¡£, ä¾‹å¦‚åœ¨ä¸Šé¢çš„æ¥å£ä¸Šç»§ç»­è¡¥å……æ–‡æ¡£æ³¨è§£:

```java
package cn.refinex.api.user.client;

@Tag(name = "ç”¨æˆ·æœåŠ¡")
public interface UserService {
    
    @GetMapping("/users/{id}")
    @Operation(summary = "æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·")
    @Parameter(description = "ç”¨æˆ·ID", required = true)
    UserDTO getUser(@PathVariable("id") Long id);
}
```

å‚æ•°æ ¡éªŒï¼ˆ`@Valid`, `@NotNull` ç­‰ï¼‰å»ºè®®ä»…åœ¨æ¥å£å±‚ç¼–å†™ï¼ŒæœåŠ¡å®ç°æ–¹æ— éœ€é‡å¤ç¼–å†™ã€‚ä¾‹å¦‚ï¼š

```java
package cn.refinex.api.user.client;

@Validated
@Tag(name = "ç”¨æˆ·æœåŠ¡")
public interface UserService {
    
    @GetMapping("/users/{id}")
    @Operation(summary = "æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·")
    @Parameter(description = "ç”¨æˆ·ID", required = true)
    UserDTO getUser(@PathVariable("id") @NotNull(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º") Long id);
}
```

### 3.2 æœåŠ¡æä¾›æ–¹æ¨¡å—ï¼ˆProviderï¼‰

æ¨¡å—åå»ºè®®ï¼š refinex-<service-name>

åŒ…å‘½åå»ºè®®ï¼š

```java
cn.refinex.<service-name>.controller    â† å®ç°æ¥å£ï¼ˆControllerï¼‰
cn.refinex.<service-name>.service       â† ä¸šåŠ¡é€»è¾‘
cn.refinex.<service-name>.repository    â† æ•°æ®è®¿é—®å±‚
```

æœåŠ¡æä¾›æ–¹ POM XML ä¾èµ–APIå¥‘çº¦å±‚ï¼š

```xml
<dependency>
    <groupId>cn.refinex</groupId>
    <artifactId>refinex-api-platform</artifactId>
</dependency>
```

ç¤ºä¾‹ï¼š

```java
package cn.refinex.platform.controller;

import cn.refinex.api.platform.client.UserService;

@RestController
public class UserController implements UserService {

    @Override
    public UserDTO getUser(Long id) {
        // å®é™…ä¸šåŠ¡é€»è¾‘
        return userMapper.toDTO(userRepository.findById(id));
    }
}
```

> æ³¨æ„ï¼š
> 1. å®ç°æ¥å£ï¼Œä¿æŒå¥‘çº¦ä¸€è‡´
> 2. ä¸éœ€è¦é‡å¤å†™ @GetMappingã€@PathVariable ç­‰æ³¨è§£ï¼Œä¿æŒä¸å¥‘çº¦ä¸€è‡´
> 3. å¯é€šè¿‡ Swagger è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

### 3.3 æœåŠ¡è°ƒç”¨æ–¹æ¨¡å—ï¼ˆConsumerï¼‰

æ¨¡å—åå»ºè®®ï¼š refinex-<service-name>

åŒ…å‘½åå»ºè®®ï¼š

```java
cn.refinex.<service-name>.feign      â† Feign å®¢æˆ·ç«¯åŒ…ï¼Œç”¨äºå®šä¹‰è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œç»§æ‰¿æœåŠ¡æä¾›æ–¹å®šä¹‰çš„æ¥å£
cn.refinex.<service-name>.service    â† ä¸šåŠ¡é€»è¾‘
cn.refinex.<service-name>.controller â† æ§åˆ¶å™¨åŒ…ï¼Œç”¨äºå¤„ç† HTTP è¯·æ±‚
```

æœåŠ¡è°ƒç”¨æ–¹ POM XML ä¾èµ–APIå¥‘çº¦å±‚å’Œ OpenFeignï¼š

```xml
<dependency>
    <groupId>cn.refinex</groupId>
    <artifactId>refinex-api-platform</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

ç¤ºä¾‹ï¼š

```java
package cn.refinex.auth.feign;

import cn.refinex.api.platform.client.UserService;
import org.springframework.cloud.openfeign.FeignClient;

@FeignClient(name = "refinex-platform")
public interface UserFeignClient extends UserService {
}
```

> æ³¨æ„:
> 1. ç»§æ‰¿ UserService å¥‘çº¦æ¥å£
> 2. FeignClient åªå‡ºç°åœ¨è°ƒç”¨æ–¹
> 3. ä¸æœåŠ¡åç»‘å®šï¼ˆé€šè¿‡æ³¨å†Œä¸­å¿ƒå‘ç°ï¼‰

## æ€»ç»“

| å±‚çº§      | æ¨¡å—            | æ˜¯å¦å«Feignæ³¨è§£ | æ˜¯å¦å«Controlleræ³¨è§£ | èŒè´£      |
| ------- |---------------| ---------- | --------------- | ------- |
| API å¥‘çº¦å±‚ | `refinex-api-xxx` | âŒ å¦        | âŒ å¦             | å®šä¹‰æ¥å£ä¸æ¨¡å‹ |
| æä¾›æ–¹     | `refinex-xxx` | âŒ å¦        | âœ… æ˜¯             | å®ç°APIæ¥å£ |
| è°ƒç”¨æ–¹     | `refinex-xxx` | âœ… æ˜¯        | âŒ å¦             | å£°æ˜è¿œç¨‹è°ƒç”¨  |
